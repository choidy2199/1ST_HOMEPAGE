<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ë²ˆì—­ê¸°</title>
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ê¸°ë³¸ ê¸€ê¼´ ì„¤ì • */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e5e7eb; /* ë°ì€ ìŠ¬ë ˆì´íŠ¸ ìƒ‰ìƒ ë°°ê²½ */
        }
        /* ëŒ€ìƒ ì–¸ì–´ ì…ë ¥ë€ì— í¬ì»¤ìŠ¤ íš¨ê³¼ ì œê±° */
        #outputText {
            cursor: default;
        }
        /* ì•± ì»¨í…Œì´ë„ˆì˜ ìµœì†Œ ë†’ì´ ì„¤ì • */
        #app {
             min-height: 80vh; 
        }
        /* í…ìŠ¤íŠ¸ ì˜ì—­ì˜ ë¶€ëª¨ ìš”ì†Œë¥¼ relativeë¡œ ì„¤ì •í•˜ì—¬ ë²„íŠ¼ê³¼ íŒŒì¼ ì…ë ¥ì„ ì œì–´ */
        #sourceContainer {
            position: relative;
        }
        /* ì»¤ìŠ¤í…€ ê·¸ë¦¼ì (ëª¨ë˜í•œ ëŠë‚Œì„ ìœ„í•´) */
        .shadow-custom {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* ë©”ì¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ë§ì„ ìœ„í•œ ê·¸ë¼ë””ì–¸íŠ¸ ì •ì˜ */
        .btn-primary {
            background-image: linear-gradient(to right, #10b981, #059669); /* emerald-500 to emerald-600 */
        }
        .btn-primary:hover {
            background-image: linear-gradient(to right, #059669, #10b981);
        }
        .btn-secondary {
            background-image: linear-gradient(to right, #6366f1, #4f46e5); /* indigo-500 to indigo-600 */
        }
        .btn-secondary:hover {
             background-image: linear-gradient(to right, #4f46e5, #6366f1);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- ì°½ í¬ê¸°ë¥¼ max-w-5xlë¡œ í™•ì¥ -->
    <div id="app" class="w-full max-w-5xl bg-white shadow-2xl rounded-2xl p-8 space-y-8 shadow-custom">
        <h1 class="text-4xl font-extrabold text-gray-900 text-center mb-6 tracking-tight">
            ğŸŒ ì‹¤ì‹œê°„ ë²ˆì—­ê¸° | CHOI.LAB
        </h1>
        
        <!-- API Key Input Section (í™˜ê²½ ë³€ìˆ˜ê°€ ì—†ê±°ë‚˜ ë¡œì»¬ íŒŒì¼ ì‹¤í–‰ ì‹œì—ë§Œ í‘œì‹œë©ë‹ˆë‹¤.) -->
        <div id="apiKeySection" class="p-4 bg-yellow-50 border border-yellow-300 rounded-xl mb-4 hidden">
            <label for="apiKeyInput" class="block text-sm font-medium text-yellow-800 mb-2">
                âš ï¸ **Gemini API Key ì…ë ¥** (ë²ˆì—­ì„ ìœ„í•´ í•„ìˆ˜)
            </label>
            <div class="flex space-x-2 mb-2">
                <input type="password" id="apiKeyInput" class="flex-1 p-2 border border-gray-300 rounded-lg text-sm focus:ring-yellow-500 focus:border-yellow-500" placeholder="ì—¬ê¸°ì— API í‚¤ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”">
                <button id="saveApiKeyBtn" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white text-sm font-semibold rounded-lg transition transform hover:scale-[1.02] active:scale-[0.98]">
                    ì €ì¥
                </button>
            </div>
            
            <!-- API í‚¤ ë°œê¸‰ í˜ì´ì§€ë¡œ ì´ë™ ë²„íŠ¼ ì¶”ê°€ -->
            <button id="getApiKeyBtn" class="w-full px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-semibold rounded-lg transition transform hover:scale-[1.005]">
                ğŸš€ API í‚¤ ë°œê¸‰ í˜ì´ì§€ë¡œ ì´ë™
            </button>
            <p id="apiKeyStatus" class="mt-2 text-xs text-yellow-700">API í‚¤ê°€ ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
        </div>
        
        <!-- ì–¸ì–´ ì„ íƒ ë° ë°©í–¥ ì „í™˜ ì„¹ì…˜ -->
        <div class="flex items-center justify-between space-x-4 mb-6">
            <!-- Source Language -->
            <select id="sourceLang" class="flex-1 p-3 border border-gray-300 rounded-xl text-lg bg-white shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-200 ease-in-out">
                <option value="auto" selected>ìë™ ê°ì§€ (Auto-Detect)</option>
                <option value="ko">í•œêµ­ì–´ (Korean)</option>
                <option value="en">ì˜ì–´ (English)</option>
                <option value="zh">ì¤‘êµ­ì–´ (Chinese)</option>
                <option value="ja">ì¼ë³¸ì–´ (Japanese)</option>
                <option value="es">ìŠ¤í˜ì¸ì–´ (Spanish)</option>
            </select>

            <!-- Swap Button -->
            <button id="swapBtn" class="p-3 bg-indigo-500 hover:bg-indigo-600 text-white rounded-full shadow-lg transition duration-200 ease-in-out transform hover:scale-110 active:scale-95 disabled:opacity-50" title="ì–¸ì–´ ì „í™˜">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                </svg>
            </button>
            
            <!-- Target Language -->
            <select id="targetLang" class="flex-1 p-3 border border-gray-300 rounded-xl text-lg bg-white shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-200 ease-in-out">
                <option value="ko" selected>í•œêµ­ì–´ (Korean)</option>
                <option value="en">ì˜ì–´ (English)</option>
                <option value="zh">ì¤‘êµ­ì–´ (Chinese)</option>
                <option value="ja">ì¼ë³¸ì–´ (Japanese)</option>
                <option value="es">ìŠ¤í˜ì¸ì–´ (Spanish)</option>
            </select>
        </div>

        <!-- ì…ë ¥ ë° ì¶œë ¥ í…ìŠ¤íŠ¸ ì˜ì—­ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- ì…ë ¥ í…ìŠ¤íŠ¸ ë° ì´ë¯¸ì§€ ì˜ì—­ í†µí•© -->
            <div id="sourceContainer">
                <label for="inputText" class="block text-sm font-medium text-gray-700 mb-2">
                    ì›ë¬¸ (Source Text) <span class="text-xs text-indigo-500 font-normal ml-2">(Ctrl+V ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥)</span>
                </label>
                
                <!-- Hidden file input for programmatically triggering file selection -->
                <input type="file" id="imageInput" accept="image/*" class="hidden"> 
                
                <!-- Image Preview Container -->
                <div id="imagePreviewContainer" class="mb-3 hidden p-3 border-2 border-dashed border-indigo-400 bg-indigo-50 rounded-xl">
                    <p class="text-xs font-medium text-indigo-700 mb-2">ğŸ“¸ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°:</p>
                    <img id="imagePreview" class="max-w-full h-auto rounded-lg shadow-md object-contain max-h-48 mx-auto" alt="Image Preview">
                    <button id="removeImageBtn" class="mt-3 w-full px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-sm font-medium rounded-lg transition transform hover:scale-[1.01] active:scale-[0.99] shadow-md">ì´ë¯¸ì§€ ì œê±°</button>
                </div>
                
                <!-- The actual Text Area (now also the paste target for images) -->
                <textarea id="inputText" rows="8" class="w-full p-4 border border-gray-300 rounded-xl shadow-inner focus:ring-indigo-500 focus:border-indigo-500 resize-none transition duration-200 ease-in-out placeholder-gray-400" placeholder="ì—¬ê¸°ì— ë²ˆì—­í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>
                
                <!-- File Select Button - linked to the hidden imageInput -->
                <button id="selectFileBtn" class="mt-3 w-full px-3 py-2 bg-indigo-50 text-indigo-700 hover:bg-indigo-100 text-sm font-semibold rounded-xl shadow-md transition transform hover:scale-[1.005]">
                    ğŸ“ ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ
                </button>
            </div>
            
            <!-- ì¶œë ¥ í…ìŠ¤íŠ¸ ì˜ì—­ -->
            <div>
                <label for="outputText" class="block text-sm font-medium text-gray-700 mb-2">ë²ˆì—­ë¬¸ (Translated Text)</label>
                <div id="outputText" class="w-full h-full p-4 border border-gray-300 rounded-xl bg-gray-100 min-h-[18rem] overflow-auto transition duration-200 ease-in-out text-gray-800 shadow-inner">
                    ë²ˆì—­ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                </div>
            </div>
        </div>

        <!-- ë²ˆì—­, ì´ˆê¸°í™”, íˆìŠ¤í† ë¦¬ ë²„íŠ¼ ë° ìƒíƒœ ë©”ì‹œì§€ -->
        <div class="flex flex-col sm:flex-row items-center justify-between pt-4">
            <div class="flex space-x-3 w-full sm:w-auto"> <!-- Wrap buttons in a container -->
                <button id="translateBtn" class="flex-1 px-4 py-2 whitespace-nowrap btn-primary text-white font-bold rounded-xl shadow-xl transition duration-200 ease-in-out transform hover:scale-[1.03] active:scale-[0.98] disabled:opacity-50">
                    ë²ˆì—­í•˜ê¸°
                </button>
                <button id="clearBtn" class="flex-1 px-4 py-2 whitespace-nowrap bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold rounded-xl shadow-md transition duration-200 ease-in-out transform hover:scale-[1.03] active:scale-[0.98]">
                    ì´ˆê¸°í™”
                </button>
                <button id="historyBtn" class="flex-1 px-4 py-2 whitespace-nowrap btn-secondary text-white font-semibold rounded-xl shadow-xl transition duration-200 ease-in-out transform hover:scale-[1.03] active:scale-[0.98]">
                    ğŸ“Š íˆìŠ¤í† ë¦¬
                </button>
            </div>

            <!-- ë¡œë”© ë° ì—ëŸ¬ ë©”ì‹œì§€ -->
            <div id="statusMessage" class="mt-4 sm:mt-0 text-lg text-center font-medium text-gray-600 flex items-center space-x-2">
                <span>ë²ˆì—­í•  ë‚´ìš©ì„ ì…ë ¥í•˜ê³  ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</span>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto p-6 space-y-4">
            <h2 class="text-3xl font-bold text-gray-900 border-b pb-2">ë²ˆì—­ ê¸°ë¡ (Translation History)</h2>
            <div id="historyContent" class="space-y-6">
                <!-- History items will be inserted here -->
            </div>
            <div class="flex space-x-4 mt-4">
                <button id="closeHistoryBtn" class="flex-1 px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg transition shadow-lg">
                    ë‹«ê¸°
                </button>
                <button id="clearHistoryBtn" class="flex-1 px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold rounded-lg transition shadow-lg">
                    ê¸°ë¡ ì „ì²´ ì‚­ì œ
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Gemini API í˜¸ì¶œì„ ìœ„í•œ ê¸°ë³¸ ì„¤ì •
        const MODEL_NAME = 'gemini-2.5-flash-preview-09-2025';
        
        // 1. í™˜ê²½ ë³€ìˆ˜ì—ì„œ API í‚¤ ì¶”ì¶œ ì‹œë„ (__initial_api_keyëŠ” ìº”ë²„ìŠ¤ í™˜ê²½ì—ì„œ ì œê³µë˜ëŠ” ì „ì—­ ë³€ìˆ˜)
        const canvasApiKey = typeof __initial_api_key !== 'undefined' ? __initial_api_key : '';
        
        // 2. localStorageì—ì„œ í‚¤ë¥¼ ë¶ˆëŸ¬ì˜´ (ë¡œì»¬ íŒŒì¼ ì‹¤í–‰ ì‹œ ì‚¬ìš©)
        let userApiKey = localStorage.getItem('geminiApiKey') || ""; 

        // ìµœì¢… ì‚¬ìš©í•  API í‚¤ ê²°ì • (ìº”ë²„ìŠ¤ í‚¤ > ë¡œì»¬ ì €ì¥ í‚¤)
        if (canvasApiKey) {
            userApiKey = canvasApiKey;
        }

        // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const inputTextarea = document.getElementById('inputText');
        const outputDiv = document.getElementById('outputText');
        const sourceLangSelect = document.getElementById('sourceLang');
        const targetLangSelect = document.getElementById('targetLang');
        const translateBtn = document.getElementById('translateBtn');
        const swapBtn = document.getElementById('swapBtn');
        const clearBtn = document.getElementById('clearBtn'); 
        const historyBtn = document.getElementById('historyBtn'); 
        const statusMessage = document.getElementById('statusMessage');
        const imageInput = document.getElementById('imageInput');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const removeImageBtn = document.getElementById('removeImageBtn');
        const selectFileBtn = document.getElementById('selectFileBtn'); 
        
        // API Key Elements
        const apiKeySection = document.getElementById('apiKeySection'); // ì„¹ì…˜ ì „ì²´ë¥¼ ê°€ì ¸ì˜´
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
        const getApiKeyBtn = document.getElementById('getApiKeyBtn'); // ì¶”ê°€ëœ ë²„íŠ¼
        const apiKeyStatus = document.getElementById('apiKeyStatus');
        
        // History Modal Elements
        const historyModal = document.getElementById('historyModal');
        const historyContent = document.getElementById('historyContent');
        const closeHistoryBtn = document.getElementById('closeHistoryBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');

        // ì–¸ì–´ ì½”ë“œ ë§¤í•‘ (ì‚¬ìš©ìì—ê²Œ í‘œì‹œí•  ì´ë¦„)
        const langMap = {
            'ko': 'í•œêµ­ì–´',
            'en': 'ì˜ì–´',
            'zh': 'ì¤‘êµ­ì–´',
            'ja': 'ì¼ë³¸ì–´',
            'es': 'ìŠ¤í˜ì¸ì–´',
            'auto': 'ìë™ ê°ì§€'
        };

        // Global state
        let imageB64Data = null;
        let imageMimeType = null;
        let translationHistory = []; // ë²ˆì—­ ê¸°ë¡ ì €ì¥ ë°°ì—´

        // --- Utility Functions ---
        
        // API í‚¤ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateApiKeyStatus() {
            if (canvasApiKey) {
                // ìº”ë²„ìŠ¤ í™˜ê²½ì—ì„œ í‚¤ê°€ ì œê³µë˜ë©´, ì‚¬ìš©ìì—ê²Œ ì´ ì‚¬ì‹¤ì„ ì•Œë¦¼
                apiKeySection.classList.add('hidden');
            } else if (userApiKey) {
                // ë¡œì»¬ í™˜ê²½ì—ì„œ localStorage í‚¤ê°€ ìˆìœ¼ë©´
                // ë©”ì‹œì§€ë¥¼ ìˆ˜ì •í•˜ì—¬ í‚¤ê°€ ì €ì¥ë˜ì–´ ìœ ì§€ëœë‹¤ëŠ” ê²ƒì„ ëª…í™•íˆ í‘œì‹œ
                apiKeyStatus.textContent = "âœ… API í‚¤ê°€ ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ì–´ ìœ ì§€ë©ë‹ˆë‹¤. (***" + userApiKey.slice(-4) + ")";
                apiKeyStatus.classList.remove('text-yellow-700', 'text-red-500');
                apiKeyStatus.classList.add('text-green-700');
                apiKeyInput.value = '********';
            } else {
                // í‚¤ê°€ ì—†ìœ¼ë©´ ì‚¬ìš©ìì—ê²Œ ì…ë ¥ ìš”ì²­
                apiKeySection.classList.remove('hidden');
                apiKeyStatus.textContent = "âŒ API í‚¤ë¥¼ ë°œê¸‰ë°›ì•„ ì…ë ¥ í›„ ì €ì¥í•´ì£¼ì„¸ìš”.";
                apiKeyStatus.classList.remove('text-green-700');
                apiKeyStatus.classList.add('text-red-500');
            }
            checkLanguageSelection(); // í‚¤ ìƒíƒœì— ë”°ë¼ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
        }
        
        // ìƒíƒœ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateStatus(message, isLoading = false, isError = false) {
            statusMessage.innerHTML = isLoading 
                ? `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>${message}</span>`
                : `<span>${message}</span>`;
            statusMessage.classList.toggle('text-red-500', isError);
            statusMessage.classList.toggle('text-gray-600', !isError && !isLoading);
            // ë²ˆì—­ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” ë¡œì§ì€ checkLanguageSelectionì—ì„œ ì²˜ë¦¬
        }

        /**
         * ì§€ìˆ˜ ë°±ì˜¤í”„ë¥¼ ì‚¬ìš©í•˜ì—¬ API í˜¸ì¶œì„ ì‹œë„í•©ë‹ˆë‹¤.
         * @param {object} payload - APIì— ì „ì†¡í•  í˜ì´ë¡œë“œ
         */
        async function fetchWithBackoff(payload, maxRetries = 3) {
            const currentApiKey = userApiKey || canvasApiKey;
            if (!currentApiKey) {
                throw new Error("API Keyê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í‚¤ë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.");
            }
            
            const currentApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${currentApiKey}`;
            
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(currentApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return response.json();
                    }

                    if (response.status === 429 || response.status >= 500) {
                        if (attempt === maxRetries - 1) {
                            throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status} ${response.statusText}`);
                        }
                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }

                    const errorJson = await response.json().catch(() => ({}));
                    const errorMessage = errorJson.error?.message || response.statusText;
                    throw new Error(`API í˜¸ì¶œ ì˜¤ë¥˜: ${response.status} - ${errorMessage}`);

                } catch (error) {
                    if (attempt === maxRetries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼");
        }
        
        // File/blobì„ Base64ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function fileToGenerativePart(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64Data = reader.result.split(',')[1]; 
                    resolve({
                        inlineData: {
                            data: base64Data,
                            mimeType: file.type
                        }
                    });
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // ì´ë¯¸ì§€ ì œê±° ë¡œì§
        function removeImage() {
            imageB64Data = null;
            imageMimeType = null;
            imageInput.value = '';
            imagePreview.src = '';
            imagePreviewContainer.classList.add('hidden');
            
            const defaultPrompt = "ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•´ ë²ˆì—­í•´ì¤˜.";
            if (inputTextarea.value.trim() === defaultPrompt) {
                 inputTextarea.value = "";
            }
            
            checkLanguageSelection();
        }
        
        // ì…ë ¥ ë‚´ìš© ë° ì´ë¯¸ì§€ ì´ˆê¸°í™” í•¨ìˆ˜
        function clearInput() {
            inputTextarea.value = "";
            outputDiv.textContent = "ë²ˆì—­ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.";
            if (imageB64Data) {
                removeImage(); // ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì´ë¯¸ì§€ë„ ì œê±°
            } else {
                checkLanguageSelection();
            }
            translateBtn.disabled = true;
            updateStatus("ë²ˆì—­í•  ë‚´ìš©ì„ ì…ë ¥í•˜ê³  ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.");
        }


        // ì´ë¯¸ì§€ íŒŒì¼/Blobì„ ì²˜ë¦¬í•˜ê³  UIë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
        async function processImage(file) {
            updateStatus("ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘...", true);
            try {
                // ê¸°ì¡´ ì´ë¯¸ì§€ê°€ ìˆë‹¤ë©´ ì œê±°
                if (imageB64Data) {
                    removeImage();
                }

                // 1. Convert file/blob to Base64 part
                const part = await fileToGenerativePart(file);
                imageB64Data = part.inlineData.data;
                imageMimeType = part.inlineData.mimeType;
                
                // 2. Update UI preview
                imagePreview.src = URL.createObjectURL(file);
                imagePreviewContainer.classList.remove('hidden');
                
                // 3. Activate button and set default prompt if necessary
                
                const currentText = inputTextarea.value.trim();
                const defaultPrompt = "ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•´ ë²ˆì—­í•´ì¤˜.";

                if (currentText.length === 0 || currentText === defaultPrompt) {
                    inputTextarea.value = defaultPrompt; 
                }
                
                // 4. Reset file input to visually clear it if pasted or loaded
                imageInput.value = ''; 
                
                checkLanguageSelection();
                updateStatus("ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ë²ˆì—­ì„ ì‹œì‘í•˜ì„¸ìš”.", false, false);
            } catch (error) {
                console.error("ì´ë¯¸ì§€ ì²˜ë¦¬ ì˜¤ë¥˜:", error);
                updateStatus("ì´ë¯¸ì§€ íŒŒì¼ì„ ì²˜ë¦¬í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", false, true);
                imageB64Data = null;
                imageMimeType = null;
                imageInput.value = '';
            }
        }

        // Paste Event Handler: í´ë¦½ë³´ë“œì—ì„œ ì´ë¯¸ì§€ íŒŒì¼ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.
        function handlePaste(event) {
            const items = (event.clipboardData || event.originalEvent.clipboardData).items;
            let imageFound = false;
            
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.startsWith('image/')) {
                    const blob = items[i].getAsFile();
                    if (blob) {
                        event.preventDefault(); // ê¸°ë³¸ ë¶™ì—¬ë„£ê¸° ë™ì‘ ë°©ì§€
                        imageFound = true;
                        
                        // ê¸°ì¡´ ì´ë¯¸ì§€ê°€ ìˆë‹¤ë©´ ì œê±° í›„ ìƒˆ ì´ë¯¸ì§€ ì²˜ë¦¬
                        processImage(blob);
                        break;
                    }
                }
            }

            if (imageFound) {
                 updateStatus("í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ë¥¼ ê°ì§€í–ˆìŠµë‹ˆë‹¤. ì²˜ë¦¬ ì¤‘...", true);
            }
        }

        // ì–¸ì–´ ì„ íƒ ìƒíƒœ í™•ì¸ ë° ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
        function checkLanguageSelection() {
            const source = sourceLangSelect.value;
            const target = targetLangSelect.value;
            const hasInput = inputTextarea.value.trim().length > 0 || imageB64Data !== null;
            
            // API í‚¤ê°€ ìˆëŠ”ì§€ í™•ì¸ (í™˜ê²½ ë³€ìˆ˜ ë˜ëŠ” ë¡œì»¬ ì €ì¥ì†Œ)
            const isApiKeyValid = canvasApiKey || userApiKey;
            
            if (!isApiKeyValid) {
                 updateStatus("âŒ API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•˜ê³  ì €ì¥í•´ì•¼ í•©ë‹ˆë‹¤.", false, true);
                 translateBtn.disabled = true;
                 return;
            }
            
            if (source !== 'auto' && source === target) {
                 updateStatus(`ì†ŒìŠ¤ ì–¸ì–´(${langMap[source]})ì™€ ëŒ€ìƒ ì–¸ì–´ê°€ ë™ì¼í•©ë‹ˆë‹¤. ì–¸ì–´ë¥¼ ë³€ê²½í•˜ê±°ë‚˜ 'ì „í™˜' ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì„¸ìš”.`, false, true);
                 translateBtn.disabled = true;
            } else {
                 if (!hasInput) {
                    updateStatus("ë²ˆì—­í•  ë‚´ìš©ì„ ì…ë ¥í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³  ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.");
                    translateBtn.disabled = true;
                 } else {
                    updateStatus("ë²ˆì—­ì„ ì‹œì‘í•  ì¤€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.", false, false);
                    translateBtn.disabled = false;
                 }
            }
            swapBtn.disabled = (source === 'auto');
        }

        // íˆìŠ¤í† ë¦¬ì— ë²ˆì—­ ê²°ê³¼ë¥¼ ì €ì¥
        function saveHistory(source, target, result) {
            const historyItem = {
                timestamp: new Date().toLocaleString(),
                sourceLang: langMap[source] || source,
                targetLang: langMap[target] || target,
                sourceText: inputTextarea.value.trim(),
                translatedText: result,
                isImage: imageB64Data !== null,
                imageURL: imageB64Data ? imagePreview.src : null // ë¯¸ë¦¬ë³´ê¸° URL ì €ì¥
            };
            // ìƒˆ í•­ëª©ì„ ê°€ì¥ ì•ì— ì¶”ê°€
            translationHistory.unshift(historyItem);
        }
        
        // íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ì„ ì—´ê³  ê¸°ë¡ì„ í‘œì‹œ
        function showHistory() {
            historyContent.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”
            
            if (translationHistory.length === 0) {
                historyContent.innerHTML = '<p class="text-center text-gray-500 py-8">ì•„ì§ ë²ˆì—­ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                translationHistory.forEach((item, index) => {
                    const historyItem = document.createElement('div');
                    // ëª¨ë‹¬ ë‚´ë¶€ ë””ìì¸ë„ ì—…ë°ì´íŠ¸ (ë” ë¶€ë“œëŸ¬ìš´ ë°°ê²½ê³¼ ê·¸ë¦¼ì)
                    historyItem.className = 'p-4 border border-gray-100 rounded-xl shadow-md bg-gray-50 hover:bg-white transition duration-150';
                    
                    let contentHTML = `
                        <div class="flex justify-between items-center text-sm text-gray-500 mb-2 border-b border-gray-200 pb-1">
                            <span class="font-bold text-indigo-600">${item.sourceLang} â†’ ${item.targetLang}</span>
                            <span class="text-xs">${item.timestamp}</span>
                        </div>
                    `;
                    
                    if (item.isImage && item.imageURL) {
                        contentHTML += `
                            <div class="mb-3">
                                <span class="text-sm font-medium text-gray-700">ì›ë¬¸ ì´ë¯¸ì§€: </span>
                                <img src="${item.imageURL}" class="max-w-full h-auto max-h-32 object-contain rounded-lg mt-1 border border-gray-300 shadow-sm" alt="Source Image">
                            </div>
                        `;
                    }
                    
                    // í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ë„ ì¡°ê¸ˆ ë” ê¹”ë”í•˜ê²Œ
                    contentHTML += `
                        <div class="mb-3">
                            <span class="text-sm font-semibold text-gray-700">ì›ë¬¸: </span>
                            <p class="text-gray-800 break-words max-h-20 overflow-hidden text-sm p-2 bg-white rounded-lg border border-gray-200">${item.sourceText}</p>
                        </div>
                        <div>
                            <span class="text-sm font-semibold text-emerald-600">ë²ˆì—­: </span>
                            <p class="text-emerald-900 font-medium break-words max-h-20 overflow-hidden p-2 bg-emerald-50 rounded-lg border border-emerald-200">${item.translatedText}</p>
                        </div>
                    `;
                    
                    historyItem.innerHTML = contentHTML;
                    historyContent.appendChild(historyItem);
                });
            }
            
            historyModal.classList.remove('hidden');
            historyModal.classList.add('flex');
        }

        // --- Main Translation Function ---
        async function translateText() {
            const textToTranslate = inputTextarea.value.trim();
            const sourceLang = sourceLangSelect.value;
            const targetLang = targetLangSelect.value;
            const targetLangName = langMap[targetLang] || targetLang;
            let systemPrompt = '';
            
            if (!textToTranslate && !imageB64Data) return;
            if (sourceLang !== 'auto' && sourceLang === targetLang) return; 
            if (!userApiKey && !canvasApiKey) {
                updateStatus("âŒ API Keyë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.", false, true);
                return;
            }

            updateStatus("ë²ˆì—­ ì¤‘...", true);
            outputDiv.textContent = 'ë²ˆì—­ ì¤‘...';
            
            const contents = [];
            const isMultimodal = imageB64Data !== null;

            if (imageB64Data) {
                contents.push({
                    inlineData: {
                        mimeType: imageMimeType,
                        data: imageB64Data
                    }
                });
            }
            
            if (textToTranslate) {
                contents.push({ parts: [{ text: textToTranslate }] });
            }

            // --- System Prompt Generation ---
            const defaultPrompt = "ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•´ ë²ˆì—­í•´ì¤˜.";
            if (isMultimodal) {
                if (textToTranslate === defaultPrompt || !textToTranslate) {
                    systemPrompt = `ë‹¹ì‹ ì€ OCR ë° ë²ˆì—­ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì£¼ì–´ì§„ ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ê³ , ê·¸ í…ìŠ¤íŠ¸ë¥¼ ì •í™•í•˜ê³  ìì—°ìŠ¤ëŸ½ê²Œ ${targetLangName}(${targetLang})ë¡œ ë²ˆì—­í•˜ì„¸ìš”. ë²ˆì—­ëœ í…ìŠ¤íŠ¸ë§Œ ì‘ë‹µí•˜ì„¸ìš”. ë‹¤ë¥¸ ì„¤ëª…ì´ë‚˜ ì¶”ê°€ì ì¸ ë¬¸ì¥ì„ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.`;
                } else if (sourceLang === 'auto') {
                    systemPrompt = `ë‹¹ì‹ ì€ OCR ë° ë²ˆì—­ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì£¼ì–´ì§„ ì´ë¯¸ì§€ì™€ í…ìŠ¤íŠ¸ë¥¼ ëª¨ë‘ ì°¸ê³ í•˜ì—¬, ì›ë³¸ ì–¸ì–´ë¥¼ ìë™ìœ¼ë¡œ ê°ì§€í•˜ê³ , ì´ ë‚´ìš©ì„ ì •í™•í•˜ê³  ìì—°ìŠ¤ëŸ½ê²Œ ${targetLangName}(${targetLang})ë¡œ ë²ˆì—­í•˜ì„¸ìš”. ë²ˆì—­ëœ í…ìŠ¤íŠ¸ë§Œ ì‘ë‹µí•˜ì„¸ìš”. ë‹¤ë¥¸ ì„¤ëª…ì´ë‚˜ ì¶”ê°€ì ì¸ ë¬¸ì¥ì„ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.`;
                } else {
                    const sourceLangName = langMap[sourceLang] || sourceLang;
                    systemPrompt = `ë‹¹ì‹ ì€ OCR ë° ë²ˆì—­ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì£¼ì–´ì§„ ì´ë¯¸ì§€ì™€ í…ìŠ¤íŠ¸ë¥¼ ëª¨ë‘ ì°¸ê³ í•˜ì—¬, ${sourceLangName}(${sourceLang})ì—ì„œ ${targetLangName}(${targetLang})ë¡œ ë‚´ìš©ì„ ì •í™•í•˜ê³  ìì—°ìŠ¤ëŸ½ê²Œ ë²ˆì—­í•˜ì„¸ìš”. ë²ˆì—­ëœ í…ìŠ¤íŠ¸ë§Œ ì‘ë‹µí•˜ì„¸ìš”. ë‹¤ë¥¸ ì„¤ëª…ì´ë‚˜ ì¶”ê°€ì ì¸ ë¬¸ì¥ì„ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.`;
                }
            } else {
                if (sourceLang === 'auto') {
                    systemPrompt = `ë‹¹ì‹ ì€ ì„¸ê³„ì ì¸ ìˆ˜ì¤€ì˜ ë²ˆì—­ê°€ì…ë‹ˆë‹¤. ì£¼ì–´ì§„ í…ìŠ¤íŠ¸ì˜ ì›ë³¸ ì–¸ì–´ë¥¼ ìë™ìœ¼ë¡œ ê°ì§€í•˜ê³ , ì´ í…ìŠ¤íŠ¸ë¥¼ ì •í™•í•˜ê³  ìì—°ìŠ¤ëŸ½ê²Œ ${targetLangName}(${targetLang})ë¡œ ë²ˆì—­í•˜ì„¸ìš”. ë²ˆì—­ëœ í…ìŠ¤íŠ¸ë§Œ ì‘ë‹µí•˜ì„¸ìš”. ë‹¤ë¥¸ ì„¤ëª…ì´ë‚˜ ì¶”ê°€ì ì¸ ë¬¸ì¥ì„ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.`;
                } else {
                    const sourceLangName = langMap[sourceLang] || sourceLang;
                    systemPrompt = `ë‹¹ì‹ ì€ ì„¸ê³„ì ì¸ ìˆ˜ì¤€ì˜ ë²ˆì—­ê°€ì…ë‹ˆë‹¤. ${sourceLangName}(${sourceLang})ì—ì„œ ${targetLangName}(${targetLang})ë¡œ ë‹¤ìŒ í…ìŠ¤íŠ¸ë¥¼ ì •í™•í•˜ê³  ìì—°ìŠ¤ëŸ½ê²Œ ë²ˆì—­í•˜ì„¸ìš”. ë²ˆì—­ëœ í…ìŠ¤íŠ¸ë§Œ ì‘ë‹µí•˜ì„¸ìš”. ë‹¤ë¥¸ ì„¤ëª…ì´ë‚˜ ì¶”ê°€ì ì¸ ë¬¸ì¥ì„ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.`;
                }
            }

            const payload = {
                contents: contents,
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const result = await fetchWithBackoff(payload);
                const translatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (translatedText) {
                    outputDiv.textContent = translatedText;
                    updateStatus("ë²ˆì—­ ì™„ë£Œ!", false, false);
                    saveHistory(sourceLang, targetLang, translatedText); // ì„±ê³µ ì‹œ íˆìŠ¤í† ë¦¬ ì €ì¥
                } else {
                    throw new Error("ë²ˆì—­ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }

            } catch (error) {
                console.error("ë²ˆì—­ ì˜¤ë¥˜:", error);
                // API í‚¤ ê´€ë ¨ ì˜¤ë¥˜ëŠ” ì‚¬ìš©ìì—ê²Œ ëª…í™•íˆ ì•Œë¦¼
                if (error.message.includes("403")) {
                     outputDiv.textContent = `ë²ˆì—­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: API í‚¤ê°€ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ í‚¤ë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.`;
                } else {
                     outputDiv.textContent = `ë²ˆì—­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`;
                }
                
                updateStatus("ë²ˆì—­ ì˜¤ë¥˜ ë°œìƒ. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.", false, true);
            }
        }

        // --- Event Listeners ---
        
        // 0. API í‚¤ ë°œê¸‰ í˜ì´ì§€ ì´ë™ ë²„íŠ¼ ì´ë²¤íŠ¸ (ì¶”ê°€)
        getApiKeyBtn.addEventListener('click', () => {
            // Google AI Studio í‚¤ ê´€ë¦¬ í˜ì´ì§€ë¡œ ì´ë™
            window.open('https://aistudio.google.com/app/apikey', '_blank');
        });

        // 1. API Key ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸
        saveApiKeyBtn.addEventListener('click', () => {
            const newKey = apiKeyInput.value.trim();
            if (newKey) {
                localStorage.setItem('geminiApiKey', newKey);
                userApiKey = newKey;
                updateApiKeyStatus();
            } else {
                // ê²½ê³  ì°½ ëŒ€ì‹  ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                updateStatus("API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", false, true);
            }
        });
        
        // 2. ë²ˆì—­ ë²„íŠ¼, ì´ˆê¸°í™” ë²„íŠ¼, íˆìŠ¤í† ë¦¬ ë²„íŠ¼ ì´ë²¤íŠ¸
        translateBtn.addEventListener('click', translateText);
        clearBtn.addEventListener('click', clearInput);
        swapBtn.addEventListener('click', () => {
             const source = sourceLangSelect.value;
             const target = targetLangSelect.value;
             // ìë™ ê°ì§€ëŠ” ëŒ€ìƒ ì–¸ì–´ê°€ ë  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, ì†ŒìŠ¤ê°€ 'auto'ê°€ ì•„ë‹ˆì–´ì•¼ í•¨.
             if (source !== 'auto') {
                 sourceLangSelect.value = target;
                 targetLangSelect.value = source;
                 checkLanguageSelection();
             }
        });
        historyBtn.addEventListener('click', showHistory);

        // 3. íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ ê´€ë ¨ ì´ë²¤íŠ¸
        closeHistoryBtn.addEventListener('click', () => {
            historyModal.classList.add('hidden');
            historyModal.classList.remove('flex');
        });
        clearHistoryBtn.addEventListener('click', () => {
            translationHistory = [];
            showHistory(); // ê¸°ë¡ ì‚­ì œ í›„ ëª¨ë‹¬ ì—…ë°ì´íŠ¸
        });
        
        // 4. ì…ë ¥ í…ìŠ¤íŠ¸ ì˜ì—­ ë³€ê²½ ì´ë²¤íŠ¸
        inputTextarea.addEventListener('input', checkLanguageSelection);
        
        // 5. ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ ë° ì œê±° ì´ë²¤íŠ¸
        imageInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file) {
                await processImage(file);
            }
        });
        removeImageBtn.addEventListener('click', removeImage);
        selectFileBtn.addEventListener('click', () => {
             imageInput.click();
        });

        // 6. ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° ì´ë²¤íŠ¸
        inputTextarea.addEventListener('paste', handlePaste); 
        
        // 7. ì–¸ì–´ ì„ íƒ ë³€ê²½ ì´ë²¤íŠ¸
        sourceLangSelect.addEventListener('change', checkLanguageSelection);
        targetLangSelect.addEventListener('change', checkLanguageSelection);
        
        // --- ì´ˆê¸°í™” ë¡œì§ ---
        function initializeApp() {
            // API í‚¤ ì„¹ì…˜ì˜ ê¸°ë³¸ ìƒíƒœë¥¼ hiddenìœ¼ë¡œ ì„¤ì •
            apiKeySection.classList.add('hidden');
            updateApiKeyStatus(); // í™˜ê²½ ë³€ìˆ˜ ì—¬ë¶€ì— ë”°ë¼ UI ê²°ì •
            checkLanguageSelection();
        }
        
        // ì´ˆê¸° ìƒíƒœ ì„¤ì •
        initializeApp();

    </script>
</body>
</html>
